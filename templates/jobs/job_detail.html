{% extends 'base.html' %}
{% load job_extras %}

{% block title %}{{ job.title }} at {{ job.organization.name }} - Remote Impact Jobs{% endblock %}

{% block meta_description %}{{ job.title }} at {{ job.organization.name }}. {{ job.location|default:"Remote" }} {{ job.get_job_type_display }} position. Apply now on Remote Impact.{% endblock %}

{% block canonical %}{{ SITE_URL }}{% url 'jobs:job_detail' job.slug %}{% endblock %}

{% block og_type %}article{% endblock %}
{% block og_title %}{{ job.title }} at {{ job.organization.name }}{% endblock %}
{% block og_description %}{{ job.location|default:"Remote" }} {{ job.get_job_type_display }} position at {{ job.organization.name }}. Apply now!{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "JobPosting",
    "title": "{{ job.title|escapejs }}",
    "description": "{{ job|job_description_for_schema|striptags|truncatechars:5000|escapejs }}",
    "datePosted": "{{ job.posted_at|date:'c' }}",
    "validThrough": "{{ job|default_expiry|date:'c' }}",
    "employmentType": "{{ job.get_job_type_display|upper }}",
    "hiringOrganization": {
        "@type": "Organization",
        "name": "{{ job.organization.name|escapejs }}",
        "sameAs": "{{ job.organization.website|default:'' }}"
    },
    "jobLocation": {
        "@type": "Place",
        "address": {
            "@type": "PostalAddress",
            "addressLocality": "{{ job.location|default:'Remote'|escapejs }}"
        }
    },
    "jobLocationType": "TELECOMMUTE",
    "applicantLocationRequirements": {
        "@type": "Country",
        "name": "Worldwide"
    },
    {% if job.salary_min or job.salary_max %}
    "baseSalary": {
        "@type": "MonetaryAmount",
        "currency": "{{ job.salary_currency|default:'USD' }}",
        "value": {
            "@type": "QuantitativeValue",
            {% if job.salary_min and job.salary_max %}"minValue": {{ job.salary_min }},
            "maxValue": {{ job.salary_max }},{% elif job.salary_min %}"value": {{ job.salary_min }},{% else %}"value": {{ job.salary_max }},{% endif %}
            "unitText": "YEAR"
        }
    },
    {% endif %}
    "directApply": true
}
</script>
{% endblock %}

{% block content %}
<!-- Align with nav -->
<!-- Align with nav -->
<section class="bg-gray-50 pt-16 pb-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
        <nav class="text-sm text-gray-500 flex items-center space-x-3">
            <a href="{% url 'jobs:home' %}" class="hover:text-brand-600 transition">Home</a>
            <span>•</span>
            <a href="{% url 'jobs:job_list' %}" class="hover:text-brand-600 transition">Jobs</a>
            <span>•</span>
            <span class="text-gray-900 line-clamp-1">{{ job.title }}</span>
        </nav>
    </div>
</section>

<section class="bg-gray-50 pb-20">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 grid lg:grid-cols-[2fr,1fr] gap-10">
        <article class="space-y-10">
            <div class="bg-white rounded-3xl border border-gray-100 p-8 shadow-sm">
                <div
                    class="flex flex-wrap items-center gap-3 mb-6 text-xs uppercase tracking-[0.05em] text-gray-500 font-semibold">
                    {% if job.category %}
                    <span
                        class="tracking-normal px-3 py-1 rounded-full bg-brand-50 text-brand-700 border border-brand-100 normal-case">{{job.category.name}}</span>
                    {% endif %}
                    <span>{{ job.get_job_type_display }}</span>
                </div>
                <div class="space-y-4 mb-8">
                    <h1 class="text-4xl md:text-5xl font-bold leading-tight text-gray-900">{{ job.title }}</h1>
                    <p class="text-2xl text-gray-600">{{ job.organization.name }}</p>
                </div>
                <div class="grid sm:grid-cols-3 gap-6 text-sm text-gray-600">
                    <div>
                        <p class="text-xs uppercase tracking-[0.05em] text-gray-400 font-semibold mb-1">Location</p>
                        <p class="text-lg text-gray-900 font-medium">{{ job.location|default:"Remote" }}</p>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-[0.05em] text-gray-400 font-semibold mb-1">Type</p>
                        <p class="text-lg text-gray-900 font-medium">{{ job.get_job_type_display }}</p>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-[0.05em] text-gray-400 font-semibold mb-1">Posted</p>
                        <p class="text-lg text-gray-900 font-medium">{{ job.posted_at|date:"M d, Y" }}</p>
                    </div>
                    {% if job.salary_min and job.salary_max %}
                    <div>
                        <p class="text-xs uppercase tracking-[0.05em] text-gray-400 font-semibold mb-1">Compensation</p>
                        <p class="text-lg text-gray-900 font-medium">{{ job.salary_currency }}
                            {{job.salary_min|floatformat:0 }} – {{ job.salary_max|floatformat:0 }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="bg-white rounded-3xl border border-gray-100 p-8 shadow-sm">
                <h2 class="text-sm uppercase tracking-[0.05em] text-gray-400 font-semibold mb-3">Mission</h2>
                <p class="text-2xl font-bold text-gray-900 mb-6">What you will drive</p>
                <div class="text-gray-600 leading-relaxed prose prose-gray max-w-none">
                    {{ job.description|render_html }}
                </div>
            </div>

            {% if job.impact %}
            <div class="bg-white rounded-3xl border border-gray-100 p-8 shadow-sm">
                <h2 class="text-sm uppercase tracking-[0.05em] text-gray-400 font-semibold mb-3">Impact</h2>
                <p class="text-2xl font-bold text-gray-900 mb-6">The difference you'll make</p>
                <div class="text-gray-600 leading-relaxed prose prose-gray max-w-none">
                    {{ job.impact|render_html }}
                </div>
            </div>
            {% endif %}

            {% if job.requirements %}
            <div class="bg-white rounded-3xl border border-gray-100 p-8 shadow-sm">
                <h2 class="text-sm uppercase tracking-[0.05em] text-gray-400 font-semibold mb-3">Profile</h2>
                <p class="text-2xl font-bold text-gray-900 mb-6">What makes you a great fit</p>
                <div class="text-gray-600 leading-relaxed prose prose-gray max-w-none">
                    {{ job.requirements|render_html }}
                </div>
            </div>
            {% endif %}

            {% if job.benefits %}
            <div class="bg-white rounded-3xl border border-gray-100 p-8 shadow-sm">
                <h2 class="text-sm uppercase tracking-[0.05em] text-gray-400 font-semibold mb-3">Benefits</h2>
                <p class="text-2xl font-bold text-gray-900 mb-6">What's in it for you</p>
                <div class="text-gray-600 leading-relaxed prose prose-gray max-w-none">
                    {{ job.benefits|render_html }}
                </div>
            </div>
            {% endif %}

            {% if job.company_description or job.organization.description %}
            <div class="bg-white rounded-3xl border border-gray-100 p-8 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-sm uppercase tracking-[0.05em] text-gray-400 font-semibold mb-3">About</h2>
                        <p class="text-2xl font-bold text-gray-900">Inside {{ job.organization.name }}</p>
                    </div>
                    {% if job.organization.website %}
                    <a href="{{ job.organization.website }}" target="_blank" rel="noopener noreferrer"
                        class="px-4 py-2 rounded-full border border-gray-200 text-sm font-semibold text-gray-600 hover:border-gray-300 hover:text-gray-900 transition bg-white">
                        Visit site →
                    </a>
                    {% endif %}
                </div>
                <div class="text-gray-600 leading-relaxed prose prose-gray max-w-none">
                    {% if job.company_description %}
                        {{ job.company_description|render_html }}
                    {% else %}
                        {{ job.organization.description|render_html }}
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </article>

        <aside class="space-y-6">
            {% if match_data %}
            <!-- Match Score Section -->
            <div class="bg-white rounded-3xl border border-gray-100 p-6 shadow-sm space-y-4">
                <div class="flex items-center justify-between">
                    <p class="text-sm uppercase tracking-[0.05em] text-gray-400 font-semibold">Your Match</p>
                    <span class="text-3xl font-bold {% if match_data.total >= 80 %}text-green-600{% elif match_data.total >= 60 %}text-yellow-600{% else %}text-gray-500{% endif %}">
                        {{ match_data.total }}%
                    </span>
                </div>

                <!-- Score breakdown -->
                <div class="space-y-2">
                    {% for key, value in match_data.breakdown.items %}
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600 capitalize">{{ key }}</span>
                        <div class="flex items-center gap-2">
                            <div class="w-20 h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div class="h-full rounded-full {% if value >= 80 %}bg-green-500{% elif value >= 60 %}bg-yellow-500{% else %}bg-gray-400{% endif %}"
                                     style="width: {{ value }}%"></div>
                            </div>
                            <span class="text-gray-500 w-8 text-right">{{ value }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if match_data.reasons %}
                <div class="pt-3 border-t border-gray-100">
                    <p class="text-xs uppercase tracking-[0.05em] text-gray-400 font-semibold mb-2">Why you match</p>
                    <ul class="space-y-1">
                        {% for reason in match_data.reasons %}
                        <li class="text-sm text-gray-600 flex items-start gap-2">
                            <span class="text-green-500 mt-0.5">✓</span>
                            {{ reason }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if match_data.gaps %}
                <div class="pt-3 border-t border-gray-100">
                    <p class="text-xs uppercase tracking-[0.05em] text-gray-400 font-semibold mb-2">Skills to develop</p>
                    <div class="flex flex-wrap gap-1">
                        {% for gap in match_data.gaps %}
                        <span class="px-2 py-1 bg-orange-50 text-orange-700 text-xs rounded-full border border-orange-100">{{ gap }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% elif not seeker_profile and user.is_authenticated %}
            <!-- Prompt to complete profile -->
            <div class="bg-gradient-to-br from-brand-50 to-brand-100 rounded-3xl border border-brand-200 p-6 shadow-sm space-y-3">
                <p class="text-sm uppercase tracking-[0.05em] text-brand-600 font-semibold">See your match</p>
                <p class="text-gray-700 text-sm">Complete your Impact Profile to see how well you match this role.</p>
                <a href="{% url 'jobs:impact_wizard' %}"
                   class="inline-block px-4 py-2 bg-brand-300 text-gray-900 text-sm font-semibold rounded-full hover:bg-brand-400 transition">
                    Build Profile
                </a>
            </div>
            {% endif %}

            <div class="bg-white rounded-3xl border border-gray-100 p-6 shadow-sm sticky top-28 space-y-6">
                <div class="space-y-3">
                    <p class="text-sm uppercase tracking-[0.05em] text-gray-400 font-semibold">Apply</p>
                    <h3 class="text-xl font-bold text-gray-900">Ready to move?</h3>
                    <p class="text-gray-500 text-sm">Remote Impact verifies every role with the hiring team. Submissions
                        go directly to {{ job.organization.name }}.</p>
                </div>
                <div class="flex items-center gap-3">
                    {% if user.is_authenticated %}
                    <button id="save-job-btn" data-url="{% url 'jobs:save_job' slug=job.slug %}"
                        data-saved="{{ saved|yesno:'true,false' }}"
                        class="flex-1 px-4 py-3 rounded-full border border-gray-200 text-gray-600 hover:border-gray-300 hover:bg-gray-50 transition text-sm font-semibold">
                        {% if saved %}Saved ✓{% else %}Save job{% endif %}
                    </button>
                    {% else %}
                    <a href="{% url 'account_login' %}?next={{ request.path }}"
                        class="flex-1 px-4 py-3 rounded-full border border-gray-200 text-gray-600 hover:border-gray-300 hover:bg-gray-50 transition text-sm font-semibold text-center">
                        Sign in to save
                    </a>
                    {% endif %}
                </div>
                {% if job.application_url %}
                <a href="{{ job.application_url }}" target="_blank" rel="noopener noreferrer"
                    class="block w-full text-center px-6 py-4 rounded-full bg-brand-300 text-gray-900 font-semibold hover:bg-brand-400 transition shadow-lg shadow-brand-300/30"
                    data-track="apply_click" data-track-category="job_action" data-track-label="{{ job.slug }}">
                    Apply on site
                </a>
                {% elif job.application_email %}
                <a href="mailto:{{ job.application_email }}?subject=Application for {{ job.title }}"
                    class="block w-full text-center px-6 py-4 rounded-full bg-brand-300 text-gray-900 font-semibold hover:bg-brand-400 transition shadow-lg shadow-brand-300/30"
                    data-track="apply_email" data-track-category="job_action" data-track-label="{{ job.slug }}">
                    Apply via email
                </a>
                {% endif %}

                <!-- Share buttons -->
                <div class="pt-4 border-t border-gray-100">
                    <p class="text-xs uppercase tracking-[0.05em] text-gray-400 font-semibold mb-3">Share this job</p>
                    <div class="flex items-center gap-2">
                        <a href="https://twitter.com/intent/tweet?text={{ job.title|urlencode }}%20at%20{{ job.organization.name|urlencode }}&url={{ SITE_URL }}{{ job.get_absolute_url|urlencode }}&hashtags=remotejobs,impactjobs"
                           target="_blank" rel="noopener noreferrer"
                           class="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-gray-200 text-gray-600 hover:border-gray-300 hover:bg-gray-50 transition text-sm"
                           data-track="share_twitter" data-track-category="share" data-track-label="{{ job.slug }}">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                            <span>Tweet</span>
                        </a>
                        <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ SITE_URL }}{{ job.get_absolute_url|urlencode }}"
                           target="_blank" rel="noopener noreferrer"
                           class="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-gray-200 text-gray-600 hover:border-gray-300 hover:bg-gray-50 transition text-sm"
                           data-track="share_linkedin" data-track-category="share" data-track-label="{{ job.slug }}">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                            <span>Share</span>
                        </a>
                        <button onclick="copyJobLink()"
                                class="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-xl border border-gray-200 text-gray-600 hover:border-gray-300 hover:bg-gray-50 transition text-sm"
                                data-track="share_copy" data-track-category="share" data-track-label="{{ job.slug }}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                            <span id="copy-btn-text">Copy</span>
                        </button>
                    </div>
                </div>
                <div class="rounded-2xl border border-gray-100 bg-gray-50 p-4 text-sm text-gray-500">
                    <p class="font-semibold text-gray-900 mb-1">Need context?</p>
                    <p>Reply to this email and our team can share culture notes & interview prep.</p>
                </div>
            </div>
        </aside>
    </div>
</section>

{% if related_jobs %}
<section class="py-16 job-related-section">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between mb-10">
            <div>
                <p class="text-sm uppercase tracking-[0.4em] text-white/60 mb-2">More like this</p>
                <h2 class="text-3xl font-semibold text-white">Similar opportunities</h2>
            </div>
            <a href="{% url 'jobs:job_list' %}"
                class="px-5 py-2 rounded-full border border-white/20 text-white/80 hover:border-white hover:text-white transition text-sm font-semibold">
                View all roles
            </a>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for related_job in related_jobs %}
            <div
                class="rounded-3xl border border-white/10 bg-card-gradient p-6 backdrop-blur hover:border-neon/60 transition">
                <p class="text-xs uppercase tracking-[0.4em] text-white/50">{{ related_job.get_job_type_display }}</p>
                <h3 class="text-xl font-semibold text-white mt-3 mb-2">
                    <a href="{{ related_job.get_absolute_url }}" class="hover:text-neon transition">
                        {{ related_job.title }}
                    </a>
                </h3>
                <p class="text-white/70 text-sm mb-4">{{ related_job.organization.name }}</p>
                <div class="flex items-center justify-between text-sm text-white/60">
                    <span>{{ related_job.location|default:"Remote" }}</span>
                    <a href="{{ related_job.get_absolute_url }}" class="text-neon font-semibold">View →</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<script>
    function copyJobLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            const btn = document.getElementById('copy-btn-text');
            btn.textContent = 'Copied!';
            setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
        });
    }
</script>
{% if user.is_authenticated %}
<script>
    (function () {
        const btn = document.getElementById('save-job-btn');
        if (!btn) return;
        const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]')?.value ||
            document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

        btn.addEventListener('click', async () => {
            const url = btn.dataset.url;
            const saved = btn.dataset.saved === 'true';
            // Track save action
            if (typeof gtag === 'function') {
                gtag('event', saved ? 'unsave_job' : 'save_job', {
                    'event_category': 'job_action',
                    'event_label': '{{ job.slug }}'
                });
            }
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken || '',
                        'Accept': 'application/json',
                    },
                });
                if (!res.ok) return;
                const data = await res.json();
                btn.dataset.saved = data.saved ? 'true' : 'false';
                btn.textContent = data.saved ? 'Saved ✓' : 'Save job';
            } catch (e) {
                console.error('Could not save job', e);
            }
        });
    })();
</script>
{% endif %}

{% endblock %}